name: Build and Publish NuGet Packages

on:
  push:
    branches: [ main, next, 'feature/**' ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, next ]

env:
  DOTNET_VERSION: '8.0.x'
  DOTNET_NOLOGO: true
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true

jobs:
  build:
    runs-on: ubuntu-latest
    
    outputs:
      version: ${{ steps.version.outputs.version }}
      is_prerelease: ${{ steps.version.outputs.is_prerelease }}
      package_suffix: ${{ steps.version.outputs.package_suffix }}
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # Full history for versioning
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Calculate version
      id: version
      run: |
        # Determine which branch to check for tags
        if [[ "${{ github.event_name }}" == "pull_request" ]]; then
          # For PRs, use the base (target) branch's latest tag
          TARGET_BRANCH="${{ github.base_ref }}"
          echo "PR detected, checking tags on target branch: $TARGET_BRANCH"
          LATEST_TAG=$(git describe --tags --abbrev=0 origin/$TARGET_BRANCH 2>/dev/null || echo "v0.10.1")
        else
          # For pushes, use current branch's latest tag
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.10.1")
        fi
        echo "Latest tag: $LATEST_TAG"
        
        # Extract version number (remove 'v' prefix)
        BASE_VERSION=${LATEST_TAG#v}
        
        # Split version into parts
        IFS='.' read -ra VERSION_PARTS <<< "$BASE_VERSION"
        MAJOR=${VERSION_PARTS[0]}
        MINOR=${VERSION_PARTS[1]}
        PATCH=${VERSION_PARTS[2]:-0}
        
        # Determine versioning based on branch/context
        if [[ "${{ github.event_name }}" == "pull_request" ]]; then
          # PR to next branch -> prerelease versions
          if [[ "${{ github.base_ref }}" == "next" ]]; then
            # feature/* -> next: use next minor version with -prerelease
            NEW_MAJOR=$MAJOR
            NEW_MINOR=$((MINOR + 1))
            NEW_PATCH=0
            BUILD_NUMBER=${{ github.run_number }}
            VERSION="$NEW_MAJOR.$NEW_MINOR.$NEW_PATCH-prerelease.$BUILD_NUMBER"
            PACKAGE_SUFFIX="prerelease"
            IS_PRERELEASE=true
            echo "Feature PR to next: $VERSION"
          # PR to main branch -> rc versions
          elif [[ "${{ github.base_ref }}" == "main" ]]; then
            # next -> main: use next minor version with -rc
            NEW_MAJOR=$MAJOR
            NEW_MINOR=$((MINOR + 1))
            NEW_PATCH=0
            BUILD_NUMBER=${{ github.run_number }}
            VERSION="$NEW_MAJOR.$NEW_MINOR.$NEW_PATCH-rc.$BUILD_NUMBER"
            PACKAGE_SUFFIX="rc"
            IS_PRERELEASE=true
            echo "PR to main (rc): $VERSION"
          fi
        elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
          # Push to main -> stable release (auto-increment)
          NEW_MAJOR=$MAJOR
          NEW_MINOR=$((MINOR + 1))
          NEW_PATCH=0
          VERSION="$NEW_MAJOR.$NEW_MINOR.$NEW_PATCH"
          PACKAGE_SUFFIX=""
          IS_PRERELEASE=false
          echo "Release version: $VERSION"
        elif [[ "${{ github.ref }}" == "refs/heads/next" ]]; then
          # Push to next -> prerelease
          NEW_MAJOR=$MAJOR
          NEW_MINOR=$((MINOR + 1))
          NEW_PATCH=0
          BUILD_NUMBER=${{ github.run_number }}
          VERSION="$NEW_MAJOR.$NEW_MINOR.$NEW_PATCH-prerelease.$BUILD_NUMBER"
          PACKAGE_SUFFIX="prerelease"
          IS_PRERELEASE=true
          echo "Next branch prerelease: $VERSION"
        elif [[ "${{ github.ref }}" == refs/heads/feature/* ]]; then
          # Push to feature branch -> prerelease
          NEW_MAJOR=$MAJOR
          NEW_MINOR=$((MINOR + 1))
          NEW_PATCH=0
          BUILD_NUMBER=${{ github.run_number }}
          VERSION="$NEW_MAJOR.$NEW_MINOR.$NEW_PATCH-prerelease.$BUILD_NUMBER"
          PACKAGE_SUFFIX="prerelease"
          IS_PRERELEASE=true
          echo "Feature branch prerelease: $VERSION"
        elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
          # Tagged release -> use tag version
          VERSION="$BASE_VERSION"
          PACKAGE_SUFFIX=""
          IS_PRERELEASE=false
          echo "Tagged release: $VERSION"
        else
          # Default fallback
          VERSION="$BASE_VERSION-dev.${{ github.run_number }}"
          PACKAGE_SUFFIX="dev"
          IS_PRERELEASE=true
          echo "Dev build: $VERSION"
        fi
        
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
        echo "package_suffix=$PACKAGE_SUFFIX" >> $GITHUB_OUTPUT
        echo "Final version: $VERSION (prerelease: $IS_PRERELEASE)"
    
    - name: Restore dependencies
      run: dotnet restore
    
    - name: Build solution
      run: |
        dotnet build --configuration Release --no-restore \
          -p:Version=${{ steps.version.outputs.version }} \
          -p:AssemblyVersion=1.0.0.0 \
          -p:FileVersion=${{ steps.version.outputs.version }} \
          -p:InformationalVersion=${{ steps.version.outputs.version }} \
          -p:MinVerSkip=true
    
    - name: Run tests
      run: dotnet test --configuration Release --no-build --verbosity normal
    
    - name: Pack CanonicaLib.DataAnnotations
      run: |
        dotnet pack CanonicaLib.DataAnnotations/CanonicaLib.DataAnnotations.csproj \
          --configuration Release \
          --no-build \
          --output ./packages \
          -p:PackageVersion=${{ steps.version.outputs.version }} \
          -p:MinVerSkip=true
    
    - name: Pack CanonicaLib.UI
      run: |
        dotnet pack CanonicaLib.UI/CanonicaLib.UI.csproj \
          --configuration Release \
          --no-build \
          --output ./packages \
          -p:PackageVersion=${{ steps.version.outputs.version }} \
          -p:MinVerSkip=true
    
    - name: Upload packages as artifacts
      uses: actions/upload-artifact@v4
      with:
        name: nuget-packages-${{ github.run_id }}
        path: ./packages/*.nupkg

  publish-prerelease:
    needs: build
    runs-on: ubuntu-latest
    # Publish prereleases for: feature branches, next branch, and PRs to next
    if: |
      (github.event_name == 'push' && (github.ref == 'refs/heads/next' || startsWith(github.ref, 'refs/heads/feature/'))) ||
      (github.event_name == 'pull_request' && github.base_ref == 'next')
    
    steps:
    - name: Download packages
      uses: actions/download-artifact@v4
      with:
        name: nuget-packages-${{ github.run_id }}
        path: ./packages
    
    - name: Publish prerelease to NuGet.org
      run: |
        echo "Publishing prerelease packages version ${{ needs.build.outputs.version }}"
        dotnet nuget push ./packages/*.nupkg \
          --api-key ${{ secrets.NUGET_API_KEY }} \
          --source https://api.nuget.org/v3/index.json \
          --skip-duplicate

  publish-rc:
    needs: build
    runs-on: ubuntu-latest
    # Publish RC versions for PRs to main
    if: github.event_name == 'pull_request' && github.base_ref == 'main'
    
    steps:
    - name: Download packages
      uses: actions/download-artifact@v4
      with:
        name: nuget-packages-${{ github.run_id }}
        path: ./packages
    
    - name: Publish RC to NuGet.org
      run: |
        echo "Publishing RC packages version ${{ needs.build.outputs.version }}"
        dotnet nuget push ./packages/*.nupkg \
          --api-key ${{ secrets.NUGET_API_KEY }} \
          --source https://api.nuget.org/v3/index.json \
          --skip-duplicate

  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Download packages
      uses: actions/download-artifact@v4
      with:
        name: nuget-packages-${{ github.run_id }}
        path: ./packages
    
    - name: Create and push tag
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Use the version calculated in the build job
        NEW_VERSION="${{ needs.build.outputs.version }}"
        NEW_TAG="v$NEW_VERSION"
        
        echo "Creating tag: $NEW_TAG"
        git tag $NEW_TAG
        git push origin $NEW_TAG
    
    - name: Create GitHub Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ needs.build.outputs.version }}
        release_name: Release ${{ needs.build.outputs.version }}
        draft: false
        prerelease: false
        body: |
          ## Changes in ${{ needs.build.outputs.version }}
          
          This release was automatically created from the main branch.
          
          ### Commits since last release:
          ${{ github.event.head_commit.message }}
    
    - name: Publish to NuGet.org
      run: |
        dotnet nuget push ./packages/*.nupkg \
          --api-key ${{ secrets.NUGET_API_KEY }} \
          --source https://api.nuget.org/v3/index.json \
          --skip-duplicate